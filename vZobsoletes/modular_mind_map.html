<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modular Mind Map</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');

        :root {
            --color-bg: #1a202c;
            --color-surface: #2d3748;
            --color-text: #e2e8f0;
            --color-text-muted: #a0aec0;
            --color-border: #4a5568;
            --color-primary: #4299e1;
            --color-primary-hover: #63b3ed;
            --color-secondary: #718096;
            --color-secondary-hover: #a0aec0;
            --color-success: #48bb78;
            --color-success-hover: #68d391;
            --color-line: #718096;
            
            --priority-high-bg: rgba(252, 129, 129, 0.2);
            --priority-high-border: #fc8181;
            --priority-medium-bg: rgba(252, 211, 77, 0.2);
            --priority-medium-border: #fcd34d;
            --priority-low-bg: rgba(56, 189, 248, 0.2);
            --priority-low-border: #38bdf8;
            
            --sidebar-width: 280px;
        }

        @keyframes bounce-in-place {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        @keyframes color-flash {
            0%, 100% { background-color: var(--original-bg); }
            30% { background-color: var(--priority-high-bg); }
            60% { background-color: var(--priority-medium-bg); }
            90% { background-color: var(--priority-low-bg); }
        }

        @keyframes connector-color-cycle {
            0%, 100% { border-color: var(--priority-high-border); }
            33% { border-color: var(--priority-medium-border); }
            66% { border-color: var(--priority-low-border); }
        }

        html {
            background-color: var(--color-surface);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            color: var(--color-text);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            box-sizing: border-box;
            display: flex;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: var(--color-bg);
            border-right: 1px solid var(--color-border);
            padding: 1.5rem;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar h2 {
            margin: 0 0 1.5rem 0;
            font-size: 1.2rem;
            color: var(--color-text);
        }

        .file-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .file-item {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background: var(--color-surface);
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-item:hover {
            background: rgba(66, 153, 225, 0.1);
        }

        .file-item.active {
            background: var(--color-primary);
            color: var(--color-bg);
        }

        .file-icon {
            font-size: 0.9rem;
        }

        .new-file-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--color-success);
            color: var(--color-bg);
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 1.5rem;
            transition: background-color 0.2s;
        }

        .new-file-btn:hover {
            background: var(--color-success-hover);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 2rem;
            overflow: auto;
        }

        .container {
            background: transparent;
            padding: 0;
            text-align: left;
        }

        h1 {
            color: var(--color-text);
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .btn {
            background-color: var(--color-primary);
            color: #1a202c;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background-color: var(--color-primary-hover);
            box-shadow: 0 4px 10px rgba(66, 153, 225, 0.2);
        }

        .btn-secondary {
            background-color: var(--color-secondary);
        }
        .btn-secondary:hover {
            background-color: var(--color-secondary-hover);
            box-shadow: 0 4px 10px rgba(113, 128, 150, 0.2);
        }
        
        .btn-success {
            background-color: var(--color-success);
        }
        .btn-success:hover {
            background-color: var(--color-success-hover);
            box-shadow: 0 4px 10px rgba(72, 187, 120, 0.2);
        }

        .canvas {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 2rem;
            background: transparent;
            border-radius: 8px;
            overflow-x: auto;
            min-height: 500px;
        }

        .node {
            display: flex;
            align-items: flex-start;
            position: relative;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .node-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .node-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            background: rgba(45, 55, 72, 0.4);
            border-radius: 10px;
            border: 2px solid var(--color-border);
            transition: all 0.2s ease;
            position: relative;
            min-width: 200px;
        }

        .node-content:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .node[data-priority="high"] .node-content {
            background: var(--priority-high-bg);
            border-color: var(--priority-high-border);
        }

        .node[data-priority="medium"] .node-content {
            background: var(--priority-medium-bg);
            border-color: var(--priority-medium-border);
        }

        .node[data-priority="low"] .node-content {
            background: var(--priority-low-bg);
            border-color: var(--priority-low-border);
        }

        .node[data-status="in-progress"] .node-content {
            animation: bounce-in-place 2s ease-in-out infinite;
        }

        .node[data-status="in-progress"].flash-enabled .node-content {
            --original-bg: var(--priority-high-bg);
            animation: bounce-in-place 2s ease-in-out infinite, color-flash 3s ease-in-out infinite;
        }

        .node[data-priority="medium"][data-status="in-progress"].flash-enabled .node-content {
            --original-bg: var(--priority-medium-bg);
        }

        .node[data-priority="low"][data-status="in-progress"].flash-enabled .node-content {
            --original-bg: var(--priority-low-bg);
        }

        .status-icon {
            font-size: 1.2rem;
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s ease;
        }

        .status-icon:hover {
            transform: scale(1.2);
        }

        .node-title {
            flex: 1;
            font-size: 0.95rem;
            font-weight: 500;
            line-height: 1.4;
            color: var(--color-text);
            cursor: text;
            min-width: 100px;
        }

        .node-title:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
            padding: 2px;
        }

        .import-indicator {
            font-size: 0.8rem;
            padding: 0.2rem 0.4rem;
            background: rgba(66, 153, 225, 0.2);
            border-radius: 4px;
            color: var(--color-primary);
            margin-left: 0.5rem;
        }

        .node-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .node-content:hover .node-actions {
            opacity: 1;
        }

        .action-btn {
            background: transparent;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .action-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .add-btn.hidden {
            display: none;
        }

        .expand-btn {
            position: absolute;
            left: -25px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--color-text-muted);
            transition: all 0.2s ease;
        }

        .expand-btn:hover {
            background: var(--color-primary);
            color: var(--color-bg);
        }

        .children {
            margin-left: 3rem;
            margin-top: 1rem;
            position: relative;
        }

        .children.collapsed {
            display: none;
        }

        .connector {
            position: absolute;
            left: -2rem;
            top: -0.5rem;
            bottom: 50%;
            width: 2rem;
            border-left: 2px solid var(--color-line);
            border-bottom: 2px solid var(--color-line);
            border-bottom-left-radius: 10px;
        }

        .connector.animated {
            animation: connector-color-cycle 4s ease-in-out infinite;
        }

        .node-comment {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: rgba(26, 32, 44, 0.4);
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--color-text-muted);
            line-height: 1.5;
            cursor: text;
        }

        .node-comment:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
            background: rgba(26, 32, 44, 0.6);
        }

        .node-comment.hidden {
            display: none;
        }

        .date-info {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(26, 32, 44, 0.3);
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--color-text-muted);
        }

        .date-info.hidden {
            display: none;
        }

        .date-range {
            display: flex;
            gap: 1rem;
        }

        .date-input {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .days-counter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .days-btn {
            background: var(--color-primary);
            color: var(--color-bg);
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .days-btn:hover {
            background: var(--color-primary-hover);
        }

        .context-menu {
            position: absolute;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
        }

        .context-menu.visible {
            display: block;
        }

        .context-menu-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .context-menu-item:hover {
            background: var(--color-surface);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--color-text-muted);
        }

        .error {
            color: #fc8181;
            padding: 1rem;
            background: rgba(252, 129, 129, 0.1);
            border-radius: 6px;
            margin: 1rem 0;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--color-text-muted);
        }

        .empty-state h3 {
            color: var(--color-text);
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>üìÅ Project Files</h2>
        <button class="new-file-btn" id="newFileBtn">+ New Mind Map</button>
        <ul class="file-list" id="fileList">
            <li class="loading">Loading files...</li>
        </ul>
    </div>

    <div class="main-content">
        <div class="container">
            <h1>üß† Modular Mind Map</h1>
            
            <div class="controls" id="controls" style="display: none;">
                <button class="btn btn-success" id="saveBtn">üíæ Save All Changes</button>
                <button class="btn btn-secondary" id="toggleCommentsBtn">üí¨ Show Comments</button>
                <button class="btn btn-secondary" id="toggleDatesBtn">üìÖ Show Dates</button>
                <button class="btn btn-secondary" id="toggleAddBtnsBtn">Hide Add Buttons</button>
                <button class="btn btn-secondary" id="expandAllBtn">Expand All</button>
                <button class="btn btn-secondary" id="collapseAllBtn">Collapse All</button>
                <button class="btn" id="animateBtn">Start Flash</button>
                <button class="btn" id="animateLinesBtn">Animate Lines</button>
            </div>

            <div id="canvas" class="canvas">
                <div class="empty-state">
                    <h3>Welcome to Modular Mind Map</h3>
                    <p>Select a file from the sidebar to begin, or create a new mind map.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" data-priority="high">üî¥ High Priority</div>
        <div class="context-menu-item" data-priority="medium">üü° Medium Priority</div>
        <div class="context-menu-item" data-priority="low">üü¢ Low Priority</div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        
        let currentFile = null;
        let xmlData = null;
        let showComments = false;
        let showDates = false;
        let showAddButtons = true;
        let flashEnabled = false;
        let animateLines = false;
        let autoSaveTimeout = null;

        // Initialize the application
        async function init() {
            await loadFileList();
            setupEventListeners();
        }

        // Load list of XML files
        async function loadFileList() {
            try {
                const response = await fetch(`${API_BASE}/files`);
                const files = await response.json();
                
                const fileList = document.getElementById('fileList');
                if (files.length === 0) {
                    fileList.innerHTML = '<li class="empty-state">No XML files found</li>';
                } else {
                    fileList.innerHTML = files.map(file => `
                        <li class="file-item" data-file="${file}">
                            <span class="file-icon">üìÑ</span>
                            <span>${file}</span>
                        </li>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load files:', error);
                document.getElementById('fileList').innerHTML = 
                    '<li class="error">Failed to connect to server. Make sure the server is running.</li>';
            }
        }

        // Load and display a mind map file
        async function loadFile(filename) {
            try {
                const response = await fetch(`${API_BASE}/load/${filename}`);
                const data = await response.json();
                
                currentFile = filename;
                xmlData = data.data;
                
                // Update UI
                document.querySelectorAll('.file-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.file === filename);
                });
                
                document.getElementById('controls').style.display = 'flex';
                renderMindMap();
            } catch (error) {
                console.error('Failed to load file:', error);
                document.getElementById('canvas').innerHTML = 
                    '<div class="error">Failed to load file. Please try again.</div>';
            }
        }

        // Render the mind map
        function renderMindMap() {
            const canvas = document.getElementById('canvas');
            canvas.innerHTML = '';
            
            if (!xmlData || !xmlData.project_plan || !xmlData.project_plan.node) {
                canvas.innerHTML = '<div class="empty-state">No data to display</div>';
                return;
            }
            
            // Ensure nodes is an array
            const nodes = Array.isArray(xmlData.project_plan.node) 
                ? xmlData.project_plan.node 
                : [xmlData.project_plan.node];
            
            nodes.forEach(nodeData => {
                const nodeElement = renderNode(nodeData);
                canvas.appendChild(nodeElement);
            });
        }

        // Render a single node and its children
        function renderNode(nodeData, isChild = false) {
            const nodeEl = document.createElement('div');
            nodeEl.className = 'node';
            nodeEl.dataset.id = nodeData.$ && nodeData.$.id || generateId();
            nodeEl.dataset.priority = nodeData.$ && nodeData.$.priority || 'medium';
            nodeEl.dataset.status = nodeData.$ && nodeData.$.status || 'pending';
            
            if (nodeData.$ && nodeData.$.dataImported === 'true') {
                nodeEl.dataset.imported = 'true';
                nodeEl.dataset.importFrom = nodeData.$.dataImportFrom;
            }
            
            const container = document.createElement('div');
            container.className = 'node-container';
            
            const content = document.createElement('div');
            content.className = 'node-content';
            
            if (flashEnabled && nodeEl.dataset.status === 'in-progress') {
                nodeEl.classList.add('flash-enabled');
            }
            
            // Status icon
            const statusIcon = document.createElement('span');
            statusIcon.className = 'status-icon';
            statusIcon.textContent = getStatusIcon(nodeEl.dataset.status);
            statusIcon.onclick = () => cycleStatus(nodeEl);
            content.appendChild(statusIcon);
            
            // Title
            const title = document.createElement('div');
            title.className = 'node-title';
            title.contentEditable = true;
            title.textContent = nodeData.$ && nodeData.$.title || 'New Node';
            title.onblur = () => autoSave();
            content.appendChild(title);
            
            // Import indicator
            if (nodeEl.dataset.imported === 'true') {
                const indicator = document.createElement('span');
                indicator.className = 'import-indicator';
                indicator.textContent = 'üîó ' + nodeEl.dataset.importFrom;
                indicator.title = 'Imported from: ' + nodeEl.dataset.importFrom;
                content.appendChild(indicator);
            }
            
            // Actions
            const actions = document.createElement('div');
            actions.className = 'node-actions';
            
            const commentBtn = document.createElement('button');
            commentBtn.className = 'action-btn';
            commentBtn.textContent = 'üí¨';
            commentBtn.onclick = () => toggleComment(nodeEl);
            actions.appendChild(commentBtn);
            
            const dateBtn = document.createElement('button');
            dateBtn.className = 'action-btn';
            dateBtn.textContent = 'üìÖ';
            dateBtn.onclick = () => toggleDateInfo(nodeEl);
            actions.appendChild(dateBtn);
            
            const addBtn = document.createElement('button');
            addBtn.className = 'action-btn add-btn';
            if (!showAddButtons) addBtn.classList.add('hidden');
            addBtn.textContent = '‚ûï';
            addBtn.onclick = () => addChildNode(nodeEl);
            actions.appendChild(addBtn);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'action-btn';
            deleteBtn.textContent = 'üóëÔ∏è';
            deleteBtn.onclick = () => deleteNode(nodeEl);
            actions.appendChild(deleteBtn);
            
            content.appendChild(actions);
            container.appendChild(content);
            
            // Comment
            const comment = document.createElement('div');
            comment.className = 'node-comment';
            if (!showComments) comment.classList.add('hidden');
            comment.contentEditable = true;
            
            // Handle comment that could be string, object with _, or array
            let commentText = '';
            if (nodeData.comment) {
                if (typeof nodeData.comment === 'string') {
                    commentText = nodeData.comment;
                } else if (typeof nodeData.comment === 'object') {
                    if (nodeData.comment._) {
                        commentText = nodeData.comment._;
                    } else if (Array.isArray(nodeData.comment) && nodeData.comment[0]) {
                        commentText = typeof nodeData.comment[0] === 'string' 
                            ? nodeData.comment[0] 
                            : (nodeData.comment[0]._ || '');
                    }
                }
            }
            
            comment.textContent = commentText;
            comment.onblur = () => autoSave();
            container.appendChild(comment);
            
            // Date info
            const dateInfo = createDateInfo(nodeData);
            if (!showDates) dateInfo.classList.add('hidden');
            container.appendChild(dateInfo);
            
            // Children
            if (nodeData.node) {
                // Ensure child nodes is an array
                const childNodes = Array.isArray(nodeData.node) ? nodeData.node : [nodeData.node];
                
                if (childNodes.length > 0) {
                    const expandBtn = document.createElement('button');
                    expandBtn.className = 'expand-btn';
                    expandBtn.textContent = '‚ñº';
                    expandBtn.onclick = () => toggleExpand(nodeEl, expandBtn);
                    content.appendChild(expandBtn);
                    
                    const children = document.createElement('div');
                    children.className = 'children';
                    
                    childNodes.forEach(childData => {
                        const childEl = renderNode(childData, true);
                        children.appendChild(childEl);
                    });
                    
                    container.appendChild(children);
                }
            }
            
            // Connector line for child nodes
            if (isChild) {
                const connector = document.createElement('div');
                connector.className = 'connector';
                if (animateLines) connector.classList.add('animated');
                container.appendChild(connector);
            }
            
            nodeEl.appendChild(container);
            
            // Context menu
            nodeEl.oncontextmenu = (e) => {
                e.preventDefault();
                showContextMenu(e, nodeEl);
            };
            
            return nodeEl;
        }

        // Create date info section
        function createDateInfo(nodeData) {
            const dateInfo = document.createElement('div');
            dateInfo.className = 'date-info';
            
            const dateRange = document.createElement('div');
            dateRange.className = 'date-range';
            
            const startDate = document.createElement('input');
            startDate.type = 'date';
            startDate.className = 'date-input';
            startDate.value = nodeData.$ && nodeData.$.startDate || '';
            startDate.onchange = () => autoSave();
            
            const endDate = document.createElement('input');
            endDate.type = 'date';
            endDate.className = 'date-input';
            endDate.value = nodeData.$ && nodeData.$.endDate || '';
            endDate.onchange = () => autoSave();
            
            dateRange.innerHTML = '<span>Start:</span>';
            dateRange.appendChild(startDate);
            dateRange.innerHTML += '<span>End:</span>';
            dateRange.appendChild(endDate);
            
            const daysCounter = document.createElement('div');
            daysCounter.className = 'days-counter';
            daysCounter.innerHTML = `
                <span>Days spent:</span>
                <button class="days-btn" onclick="decrementDays(this)">‚àí</button>
                <span class="days-value">${nodeData.$ && nodeData.$.daysSpent || 0}</span>
                <button class="days-btn" onclick="incrementDays(this)">+</button>
            `;
            
            dateInfo.appendChild(dateRange);
            dateInfo.appendChild(daysCounter);
            
            return dateInfo;
        }

        // Helper functions
        function generateId() {
            return 'node-' + Math.random().toString(36).substr(2, 9);
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'completed': return '‚úÖ';
                case 'in-progress': return 'üü°';
                default: return 'üî≤';
            }
        }

        function cycleStatus(nodeEl) {
            const statuses = ['pending', 'in-progress', 'completed'];
            const currentStatus = nodeEl.dataset.status;
            const currentIndex = statuses.indexOf(currentStatus);
            const newStatus = statuses[(currentIndex + 1) % 3];
            
            nodeEl.dataset.status = newStatus;
            nodeEl.querySelector('.status-icon').textContent = getStatusIcon(newStatus);
            
            if (flashEnabled) {
                nodeEl.classList.toggle('flash-enabled', newStatus === 'in-progress');
            }
            
            autoSave();
        }

        function toggleComment(nodeEl) {
            const comment = nodeEl.querySelector('.node-comment');
            comment.classList.toggle('hidden');
        }

        function toggleDateInfo(nodeEl) {
            const dateInfo = nodeEl.querySelector('.date-info');
            dateInfo.classList.toggle('hidden');
        }

        function addChildNode(parentEl) {
            const newNode = {
                $: {
                    title: 'New Node',
                    priority: 'medium',
                    status: 'pending',
                    id: generateId()
                }
            };
            
            const newEl = renderNode(newNode, true);
            
            let children = parentEl.querySelector('.children');
            if (!children) {
                children = document.createElement('div');
                children.className = 'children';
                
                const expandBtn = document.createElement('button');
                expandBtn.className = 'expand-btn';
                expandBtn.textContent = '‚ñº';
                expandBtn.onclick = () => toggleExpand(parentEl, expandBtn);
                parentEl.querySelector('.node-content').appendChild(expandBtn);
                
                parentEl.querySelector('.node-container').appendChild(children);
            }
            
            children.appendChild(newEl);
            autoSave();
        }

        function deleteNode(nodeEl) {
            if (confirm('Delete this node and all its children?')) {
                nodeEl.remove();
                autoSave();
            }
        }

        function toggleExpand(nodeEl, btn) {
            const children = nodeEl.querySelector('.children');
            if (children) {
                children.classList.toggle('collapsed');
                btn.textContent = children.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
            }
        }

        function showContextMenu(e, nodeEl) {
            const menu = document.getElementById('contextMenu');
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
            menu.classList.add('visible');
            
            menu.querySelectorAll('.context-menu-item').forEach(item => {
                item.onclick = () => {
                    nodeEl.dataset.priority = item.dataset.priority;
                    menu.classList.remove('visible');
                    autoSave();
                    renderMindMap();
                };
            });
        }

        function incrementDays(btn) {
            const value = btn.nextElementSibling;
            value.textContent = parseInt(value.textContent) + 1;
            autoSave();
        }

        function decrementDays(btn) {
            const value = btn.previousElementSibling;
            const current = parseInt(value.textContent);
            if (current > 0) {
                value.textContent = current - 1;
                autoSave();
            }
        }

        // Build XML from DOM
        function buildXMLFromDOM() {
            const nodes = document.querySelectorAll('#canvas > .node');
            const xmlNodes = Array.from(nodes).map(node => buildNodeXML(node));
            
            return `<?xml version="1.0" encoding="UTF-8"?>
<project_plan>
${xmlNodes.join('\n')}
</project_plan>`;
        }

        function buildNodeXML(nodeEl, indent = '    ') {
            const title = nodeEl.querySelector('.node-title').textContent;
            const comment = nodeEl.querySelector('.node-comment')?.textContent || '';
            const startDate = nodeEl.querySelector('.date-input')?.value || '';
            const endDate = nodeEl.querySelectorAll('.date-input')[1]?.value || '';
            const daysSpent = nodeEl.querySelector('.days-value')?.textContent || '0';
            
            const attrs = [
                `title="${escapeXML(title)}"`,
                `priority="${nodeEl.dataset.priority}"`,
                `status="${nodeEl.dataset.status}"`,
                `id="${nodeEl.dataset.id}"`
            ];
            
            if (startDate) attrs.push(`startDate="${startDate}"`);
            if (endDate) attrs.push(`endDate="${endDate}"`);
            if (daysSpent !== '0') attrs.push(`daysSpent="${daysSpent}"`);
            
            const childNodes = nodeEl.querySelectorAll(':scope > .node-container > .children > .node');
            
            if (childNodes.length === 0 && !comment) {
                return `${indent}<node ${attrs.join(' ')}/>`;
            }
            
            let xml = `${indent}<node ${attrs.join(' ')}>`;
            
            if (comment) {
                xml += `\n${indent}    <comment>${escapeXML(comment)}</comment>`;
            }
            
            if (childNodes.length > 0) {
                xml += '\n' + Array.from(childNodes).map(child => 
                    buildNodeXML(child, indent + '    ')
                ).join('\n');
            }
            
            xml += `\n${indent}</node>`;
            
            return xml;
        }

        function escapeXML(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }

        // Auto-save functionality
        function autoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                if (currentFile) {
                    saveFile();
                }
            }, 1000);
        }

        async function saveFile() {
            try {
                const xml = buildXMLFromDOM();
                const response = await fetch(`${API_BASE}/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: currentFile,
                        data: xml
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Save failed');
                }
                
                console.log('Saved successfully');
            } catch (error) {
                console.error('Failed to save:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // File list
            document.getElementById('fileList').addEventListener('click', (e) => {
                const fileItem = e.target.closest('.file-item');
                if (fileItem) {
                    loadFile(fileItem.dataset.file);
                }
            });
            
            // New file button
            document.getElementById('newFileBtn').onclick = async () => {
                const filename = prompt('Enter filename (e.g., project.xml):');
                if (filename && filename.endsWith('.xml')) {
                    try {
                        const response = await fetch(`${API_BASE}/create`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filename })
                        });
                        
                        if (response.ok) {
                            await loadFileList();
                            loadFile(filename);
                        } else {
                            const error = await response.json();
                            alert(error.error);
                        }
                    } catch (error) {
                        alert('Failed to create file');
                    }
                }
            };
            
            // Save button
            document.getElementById('saveBtn').onclick = () => {
                if (currentFile) {
                    saveFile();
                }
            };
            
            // Toggle buttons
            document.getElementById('toggleCommentsBtn').onclick = () => {
                showComments = !showComments;
                document.querySelectorAll('.node-comment').forEach(el => {
                    el.classList.toggle('hidden', !showComments);
                });
                document.getElementById('toggleCommentsBtn').textContent = 
                    showComments ? 'üí¨ Hide Comments' : 'üí¨ Show Comments';
            };
            
            document.getElementById('toggleDatesBtn').onclick = () => {
                showDates = !showDates;
                document.querySelectorAll('.date-info').forEach(el => {
                    el.classList.toggle('hidden', !showDates);
                });
                document.getElementById('toggleDatesBtn').textContent = 
                    showDates ? 'üìÖ Hide Dates' : 'üìÖ Show Dates';
            };
            
            document.getElementById('toggleAddBtnsBtn').onclick = () => {
                showAddButtons = !showAddButtons;
                document.querySelectorAll('.add-btn').forEach(el => {
                    el.classList.toggle('hidden', !showAddButtons);
                });
                document.getElementById('toggleAddBtnsBtn').textContent = 
                    showAddButtons ? 'Hide Add Buttons' : 'Show Add Buttons';
            };
            
            // Expand/Collapse
            document.getElementById('expandAllBtn').onclick = () => {
                document.querySelectorAll('.children').forEach(el => {
                    el.classList.remove('collapsed');
                });
                document.querySelectorAll('.expand-btn').forEach(btn => {
                    btn.textContent = '‚ñº';
                });
            };
            
            document.getElementById('collapseAllBtn').onclick = () => {
                document.querySelectorAll('.children').forEach(el => {
                    el.classList.add('collapsed');
                });
                document.querySelectorAll('.expand-btn').forEach(btn => {
                    btn.textContent = '‚ñ∂';
                });
            };
            
            // Animations
            document.getElementById('animateBtn').onclick = () => {
                flashEnabled = !flashEnabled;
                document.querySelectorAll('.node[data-status="in-progress"]').forEach(el => {
                    el.classList.toggle('flash-enabled', flashEnabled);
                });
                document.getElementById('animateBtn').textContent = 
                    flashEnabled ? 'Stop Flash' : 'Start Flash';
            };
            
            document.getElementById('animateLinesBtn').onclick = () => {
                animateLines = !animateLines;
                document.querySelectorAll('.connector').forEach(el => {
                    el.classList.toggle('animated', animateLines);
                });
                document.getElementById('animateLinesBtn').textContent = 
                    animateLines ? 'Stop Lines' : 'Animate Lines';
            };
            
            // Hide context menu on click elsewhere
            document.addEventListener('click', () => {
                document.getElementById('contextMenu').classList.remove('visible');
            });
        }

        // Initialize on load
        init();
    </script>
</body>
</html>